on:
  push:
    tags:
      - 'v*'
name: Create release

jobs:
  build:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Node.js and npm
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      - run: npm install
      - name: Build assets
        run: npm run build
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools: composer:v2
      - name: Clean vendor directory and composer.lock
        run: |
          rm -rf vendor
          rm -f composer.lock
      - name: Install production dependencies
        run: |
          composer install --no-dev --no-interaction --optimize-autoloader --classmap-authoritative
          composer dump-autoload --no-dev --optimize --classmap-authoritative
      - name: Verify no dev dependencies
        run: |
          if [ -d "vendor/phpstan" ]; then
            echo "Error: PHPStan directory found in vendor - dev dependencies installed"
            exit 1
          fi
          if [ -d "vendor/phpunit" ]; then
            echo "Error: PHPUnit directory found in vendor - dev dependencies installed"
            exit 1
          fi
          echo "No dev dependencies found in vendor directory"
      - name: Create zip file
        run: |
          zip -r auto-alt-text.zip *.php composer.json composer.lock readme.txt dist languages src vendor -x "*.git*"
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: auto-alt-text.zip
          body_path: release-body.md
